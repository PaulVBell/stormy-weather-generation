"0","kfold_predict_newdata <- function(x, newdata){"
"0","  "
"0","  # Generate posterior predictions from brms kfold object with newdata assigned to each fold."
"0","  # Arguments: x a brms kfold object, newdata a data.frame of new data with a column fold."
"0","  # Value: returns list of y, the observations, and yrep, the k-fold cross validated posterior predictive samples."
"0","  "
"0","  ndraw <- ndraws(x$fits[[1, ""fit""]])"
"0","  yrep <- matrix(NA, nrow = ndraw, ncol = nrow(newdata))"
"0","  "
"0","  for(k in 1:nrow(x$fits)){"
"0","    fit_k <- x$fits[[k, ""fit""]]"
"0","    k_index <- which(newdata$fold == k)"
"0","    yrep[, k_index] <- posterior_predict(fit_k, newdata = filter(newdata, fold == k))"
"0","  }"
"0","  y = newdata$prcp_amt_adj"
"0","  list(y = y, yrep = yrep)"
"0","}"
"0",""
"0",""
"0","amt_fit_kfold_brms <- function(data, formula, priors, cores, iter = 2000, warmup = 1000, chains = 2, kfold_chains = 1){"
"0","  "
"0","  # Wrapper for fitting the occurrence brm model, performing k-fold cross validation and posterior predictions from the k-folds."
"0","  # Arguments: usual brm arguments and kfold_chains which determines how many chains to use for the k-fold cross validation."
"0","  # Value: a list of fit, the brm fit, y, the observations, and yrep, the k-fold cross validated posterior predictive samples."
"0",""
"0","  "
"0","  fit <- brm("
"0","    formula = formula,"
"0","    family = Gamma(link = ""log""),"
"0","    data = filter(data, occur == 1),"
"0","    prior = priors,"
"0","    iter = iter,"
"0","    warmup = warmup,"
"0","    chains = chains,"
"0","    cores = cores"
"0","  )"
"0","  gc(verbose = FALSE)"
"0","  "
"0","  folds = filter(data, occur == 1)$fold"
"0","  if(cores > 1){"
"0","    plan(multisession, workers = cores)"
"0","    fit_k_fold <- kfold(fit, chains = kfold_chains, folds = folds, save_fits = TRUE)"
"0","    plan(sequential)"
"0","  }"
"0","  if(cores == 1){"
"0","    fit_k_fold <- kfold(fit, chains = kfold_chains, folds = folds, save_fits = TRUE)"
"0","  }"
"0","  gc(verbose = FALSE)"
"0","  "
"0","  fit_p <- kfold_predict_newdata(fit_k_fold, drop_na(data))"
"0","  gc(verbose = FALSE)"
"0","  "
"0","  list(fit = fit, y = fit_p$y, yrep = fit_p$yrep)"
"0","}"
